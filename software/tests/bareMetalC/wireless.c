#include <string.h>
#include <stdio.h>
#include "include/encoding.h"
#include "include/ISA.h"


#define SIZE  48
#define BOUND 10000
int A[SIZE] __attribute__((aligned(16)));
int B[SIZE] __attribute__((aligned(16)));
int C[SIZE] __attribute__((aligned(16)));
int array3[SIZE] __attribute__((aligned(16)));
int D[SIZE] __attribute__((aligned(16)));

__attribute__((noinline))

void cgra_execute(void** din_addr, void** dout_addr)
{
	static unsigned short cin[263][3] __attribute__((aligned(16))) = {
		{0x0000, 0x0000, 0x0020},
		{0x0004, 0x0000, 0x0021},
		{0x0000, 0xc185, 0x0022},
		{0x0046, 0x0220, 0x0023},
		{0x0000, 0x0000, 0x0028},
		{0x0004, 0x0000, 0x0029},
		{0x0000, 0xc185, 0x002a},
		{0x0046, 0x0020, 0x002b},
		{0x0110, 0x0000, 0x0068},
		{0x0030, 0x0000, 0x0070},
		{0x0800, 0x0000, 0x00b0},
		{0x0883, 0x0000, 0x00b8},
		{0x0004, 0x0000, 0x00f0},
		{0x0803, 0x0003, 0x00f1},
		{0x000f, 0x0211, 0x00f9},
		{0x0000, 0x0500, 0x00fa},
		{0x0000, 0x4800, 0x00fb},
		{0x0000, 0x0000, 0x00fc},
		{0x0030, 0x0000, 0x0138},
		{0x0000, 0x0008, 0x0148},
		{0x0000, 0x6000, 0x0181},
		{0x0003, 0x0000, 0x0182},
		{0x0000, 0x0050, 0x0188},
		{0x0005, 0x0000, 0x018a},
		{0x0000, 0x0300, 0x0191},
		{0x0006, 0x0000, 0x0192},
		{0x0004, 0x0000, 0x01d0},
		{0x0803, 0x0004, 0x01d2},
		{0x0000, 0x0020, 0x0210},
		{0x0010, 0x0000, 0x0218},
		{0x0000, 0x0094, 0x0259},
		{0x0000, 0x0300, 0x0261},
		{0x0180, 0x0000, 0x0262},
		{0x5836, 0x0000, 0x026a},
		{0x4000, 0x0000, 0x0272},
		{0x0300, 0x0003, 0x02a1},
		{0x0030, 0x0008, 0x02e8},
		{0x0000, 0x0060, 0x0331},
		{0x0002, 0x0000, 0x033a},
		{0x0008, 0x6001, 0x0341},
		{0x0006, 0x0000, 0x0342},
		{0x0000, 0x0004, 0x0349},
		{0xffef, 0xffff, 0x0368},
		{0x0001, 0x0003, 0x0369},
		{0x0100, 0x0003, 0x0371},
		{0x2710, 0x0000, 0x0378},
		{0x000f, 0x0004, 0x0379},
		{0x0000, 0x0200, 0x0381},
		{0x0000, 0x0000, 0x0382},
		{0x0000, 0x1600, 0x0383},
		{0x0000, 0x0000, 0x0384},
		{0x440d, 0x1c1c, 0x0389},
		{0x0000, 0xc000, 0x038a},
		{0x0010, 0x35c0, 0x038b},
		{0x0002, 0x0000, 0x038c},
		{0x0010, 0x0000, 0x03b0},
		{0x0020, 0x0000, 0x03b8},
		{0x0000, 0x0020, 0x03c0},
		{0x0003, 0x0000, 0x03c8},
		{0x3040, 0x0000, 0x03d0},
		{0x0003, 0x0001, 0x03d8},
		{0x0000, 0xc000, 0x0409},
		{0x0180, 0x0000, 0x0412},
		{0x0000, 0x0000, 0x0418},
		{0x0000, 0x0002, 0x0419},
		{0x0806, 0x0000, 0x041a},
		{0x0000, 0x00c0, 0x0421},
		{0xffef, 0xffff, 0x0440},
		{0x0001, 0x0004, 0x0441},
		{0x0004, 0x0000, 0x0448},
		{0x0803, 0x0003, 0x0449},
		{0x0001, 0x0000, 0x0450},
		{0x0001, 0x0003, 0x0451},
		{0x440d, 0x021a, 0x0459},
		{0x0000, 0x0400, 0x045a},
		{0x0000, 0x1740, 0x045b},
		{0x0000, 0x0000, 0x045c},
		{0xffef, 0xffff, 0x0460},
		{0x0701, 0x0003, 0x0461},
		{0x0004, 0x0000, 0x0468},
		{0x0803, 0x0003, 0x0469},
		{0x0000, 0x0000, 0x0488},
		{0x0301, 0x0040, 0x0490},
		{0x0120, 0x0118, 0x0498},
		{0x00c0, 0x0011, 0x04a0},
		{0x0030, 0x0000, 0x04a8},
		{0x0100, 0x0600, 0x04b0},
		{0x3000, 0x0000, 0x04d0},
		{0x0000, 0x1800, 0x04d9},
		{0x6000, 0x0000, 0x04da},
		{0x0000, 0xd400, 0x04e1},
		{0x0000, 0x0c00, 0x04e9},
		{0x0186, 0x0000, 0x04ea},
		{0x0010, 0x0000, 0x04f0},
		{0x0000, 0x0001, 0x04f1},
		{0x0806, 0x0000, 0x04f2},
		{0x8000, 0xc0c0, 0x04f9},
		{0x0000, 0x0000, 0x04fa},
		{0x0000, 0x00c0, 0x0501},
		{0x1001, 0x0024, 0x0519},
		{0x0004, 0x0000, 0x0520},
		{0x0603, 0x0001, 0x0521},
		{0x0021, 0x0000, 0x0528},
		{0x000a, 0x0201, 0x0529},
		{0x0000, 0x0900, 0x052a},
		{0x0000, 0x1a00, 0x052b},
		{0x0000, 0x0000, 0x052c},
		{0x0001, 0x0000, 0x0530},
		{0x0041, 0x0200, 0x0531},
		{0x0000, 0x0000, 0x0532},
		{0x0000, 0x1604, 0x0533},
		{0x0220, 0x0000, 0x0534},
		{0x00a0, 0x0000, 0x0535},
		{0x00a0, 0x0008, 0x0536},
		{0x0004, 0x0000, 0x0538},
		{0x0003, 0x0203, 0x0539},
		{0x0000, 0x0900, 0x053a},
		{0x0000, 0x1600, 0x053b},
		{0x0000, 0x0000, 0x053c},
		{0x0500, 0x0001, 0x0541},
		{0x0006, 0x0000, 0x0568},
		{0x0000, 0x0621, 0x0570},
		{0x0000, 0x0420, 0x0578},
		{0x0000, 0x0000, 0x0580},
		{0x0000, 0x00c0, 0x0588},
		{0x0000, 0x0400, 0x0590},
		{0x2000, 0x0000, 0x05a8},
		{0x2000, 0x6004, 0x05b1},
		{0x0000, 0x6008, 0x05b9},
		{0x0080, 0x0000, 0x05c0},
		{0x0000, 0x1400, 0x05c1},
		{0x0c76, 0x0000, 0x05c2},
		{0x0004, 0x1a01, 0x05c9},
		{0x0106, 0x0000, 0x05ca},
		{0x0100, 0x0000, 0x05d1},
		{0x00c1, 0x0000, 0x05d2},
		{0x0000, 0x0000, 0x05d9},
		{0x0004, 0x0000, 0x05da},
		{0x0001, 0x0000, 0x05f0},
		{0x0061, 0x0200, 0x05f1},
		{0x0000, 0xc000, 0x05f2},
		{0x0000, 0x3a19, 0x05f3},
		{0x0000, 0x0000, 0x05f4},
		{0x00a0, 0x0000, 0x05f5},
		{0x00a0, 0x0018, 0x05f6},
		{0x0004, 0x0000, 0x05f8},
		{0x0403, 0x0001, 0x05f9},
		{0x081c, 0x0000, 0x05fa},
		{0x0021, 0xb800, 0x05fb},
		{0x0016, 0x0000, 0x05fc},
		{0x0001, 0x0000, 0x0600},
		{0x0001, 0x0002, 0x0601},
		{0x2710, 0x0000, 0x0608},
		{0x040f, 0x0203, 0x0609},
		{0x0000, 0x1200, 0x060a},
		{0x0000, 0x1600, 0x060b},
		{0x0000, 0x0000, 0x060c},
		{0x0000, 0x0201, 0x0611},
		{0x0000, 0x0000, 0x0612},
		{0x0000, 0x1400, 0x0613},
		{0x0000, 0x0000, 0x0614},
		{0x0001, 0x0000, 0x0618},
		{0x0001, 0xc004, 0x0619},
		{0x1401, 0x4100, 0x061a},
		{0x0011, 0x3a00, 0x061b},
		{0x000a, 0x0000, 0x061c},
		{0x0000, 0x0200, 0x0621},
		{0x0000, 0x0500, 0x0622},
		{0x0000, 0x1800, 0x0623},
		{0x0000, 0x0000, 0x0624},
		{0x0300, 0x0200, 0x0640},
		{0x0300, 0x0020, 0x0648},
		{0x8030, 0x0008, 0x0650},
		{0x2200, 0x0800, 0x0658},
		{0x0000, 0x0600, 0x0660},
		{0x0003, 0x0600, 0x0668},
		{0x1000, 0x0000, 0x0680},
		{0x0040, 0x0000, 0x0688},
		{0x0018, 0x0000, 0x068a},
		{0x1000, 0x0000, 0x0690},
		{0x0001, 0x0280, 0x0691},
		{0x0218, 0x0000, 0x0692},
		{0x0000, 0x2281, 0x0699},
		{0x4000, 0x0000, 0x069a},
		{0x0000, 0xa280, 0x06a1},
		{0x0008, 0x0000, 0x06a2},
		{0x0000, 0x0100, 0x06a8},
		{0x0000, 0x0d00, 0x06a9},
		{0x4010, 0x0000, 0x06aa},
		{0x0080, 0x0000, 0x06b0},
		{0x0020, 0x0000, 0x06b2},
		{0x0004, 0x0000, 0x06b9},
		{0x2710, 0x0000, 0x06c8},
		{0x000f, 0x0204, 0x06c9},
		{0x0000, 0xc500, 0x06ca},
		{0x0000, 0x6400, 0x06cb},
		{0x0000, 0x0000, 0x06cc},
		{0x0004, 0x0000, 0x06d0},
		{0x0003, 0x0201, 0x06d1},
		{0x0000, 0x1700, 0x06d2},
		{0x0000, 0x1a00, 0x06d3},
		{0x0000, 0x0000, 0x06d4},
		{0x440d, 0x0211, 0x06d9},
		{0x0000, 0x0200, 0x06da},
		{0x0000, 0x1680, 0x06db},
		{0x0000, 0x0000, 0x06dc},
		{0x0020, 0x0000, 0x06e0},
		{0x000b, 0x0202, 0x06e1},
		{0x0000, 0x0000, 0x06e2},
		{0x0000, 0x1c00, 0x06e3},
		{0x0000, 0x0000, 0x06e4},
		{0x0021, 0x0000, 0x06e8},
		{0x010a, 0x0201, 0x06e9},
		{0x0000, 0x1c00, 0x06ea},
		{0x0000, 0x1c00, 0x06eb},
		{0x0000, 0x0000, 0x06ec},
		{0x270f, 0x0000, 0x06f0},
		{0x000f, 0x0218, 0x06f1},
		{0x0000, 0x0000, 0x06f2},
		{0x0000, 0x1c00, 0x06f3},
		{0x0000, 0x0000, 0x06f4},
		{0x0000, 0x0200, 0x0701},
		{0x0000, 0x1300, 0x0702},
		{0x0000, 0x1400, 0x0703},
		{0x0000, 0x0000, 0x0704},
		{0x0301, 0x0000, 0x0718},
		{0x0000, 0x0004, 0x0720},
		{0x0000, 0x0000, 0x0728},
		{0x3300, 0x0010, 0x0730},
		{0xc080, 0x0002, 0x0738},
		{0x0300, 0x0002, 0x0740},
		{0x0002, 0x0000, 0x0758},
		{0x0000, 0x0020, 0x0760},
		{0x0000, 0x0000, 0x0761},
		{0x0004, 0x0823, 0x0768},
		{0x0018, 0x0000, 0x0769},
		{0x0800, 0x0800, 0x0770},
		{0x001c, 0x0000, 0x0771},
		{0x7000, 0x0000, 0x0778},
		{0x0018, 0x0000, 0x0779},
		{0x001c, 0x0000, 0x0781},
		{0x1000, 0x8000, 0x0788},
		{0x0000, 0x0008, 0x0790},
		{0x0000, 0x0000, 0x07a0},
		{0x0004, 0x0000, 0x07a1},
		{0x0000, 0xc0b5, 0x07a2},
		{0x0036, 0x048c, 0x07a3},
		{0x1000, 0x0000, 0x07a8},
		{0x0004, 0x0000, 0x07a9},
		{0x0000, 0xc105, 0x07aa},
		{0x0046, 0x0616, 0x07ab},
		{0x2000, 0x0000, 0x07b8},
		{0x0004, 0x0000, 0x07b9},
		{0x0000, 0xc045, 0x07ba},
		{0x1006, 0x0480, 0x07bb},
		{0x0000, 0x0000, 0x07c0},
		{0x0004, 0x0000, 0x07c1},
		{0x0000, 0x8255, 0x07c2},
		{0x4206, 0x0108, 0x07c3},
		{0x0000, 0x0000, 0x07d0},
		{0x0004, 0x0000, 0x07d1},
		{0x0000, 0xc215, 0x07d2},
		{0x4006, 0x0410, 0x07d3},
	};

	load_cfg((void*)cin, 0x40000, 1578, 0, 0);
	load_data(din_addr[0], 0x10000, 136, 1, 0, 0);
	load_data(din_addr[1], 0x0, 136, 0, 0, 0);
	load_data(din_addr[2], 0x20000, 136, 1, 0, 0);
	load_data(din_addr[3], 0x24000, 136, 1, 0, 0);
	load_data(din_addr[4], 0x28000, 136, 0, 0, 0);
	load_data(din_addr[5], 0x30000, 136, 0, 0, 0);
	config(0x0, 263, 0, 0);
	execute(0x5b18, 0, 0);
	store(dout_addr[0], 0x30000, 136, 0, 0);
}


// void array_add(){
//    for (int i=0;i<SIZE; i++){
//       #ifdef CGRA_COMPILER
//       please_map_me();
//       #endif
//       D[i] = A[i]+B[i];
//    }
// }


void FuncDefine(int* array0, int* array2, int para0, int para1)
{
    int v0 = para1 - para0 + 1;
    
    for (int i = para0; i <= para1; i++) {
        for (int j = i + 1; j <= para1; j++) {
            if (array2[i] >= BOUND && array2[j] < BOUND) {
                D[j - para0] += 1;
            } else {
                if (array2[i] < BOUND && array2[j] < BOUND && array0[i] > array0[j]) {
                    D[j - para0] += 1;
                } else {
                    D[i - para0] += 1;
                }
            }
        }
    }
}


void result_check()
{
  int i, j;

  for (i = 0; i < SIZE; i++)
  {
    if (D[i] != array3[i]) printf("There is an error in location (%d)[%d, %d]\n", i, C[i], D[i]);
  }
}

int main(){

  int i,j;
  long long unsigned start;
  long long unsigned end;

  // for (i=0;i<SIZE; i++){
  //     A[i] = i * 2 + 5;
  //     B[i] = i * 3;
  //     C[i] = 0;
  //     D[i] = 0;
  //   }
    
  for(int i=0; i< 47; i++){
      if(i <26){
          A[i] = i;
          C[i] = i;
      }else if(i < 29){
          A[i] = 33 - i;
          C[i] = 33 - i;            
      }else{
          A[i] = i - 29;
          C[i] = i - 29; 
      }
  }
// for (i=0;i<SIZE; i++) printf("%d\n", C[i]);

  printf("Initialization finished!\n");
  
  // printf("CPU add finished!\n");
  start = rdcycle();
  /* Run kernel. */
  FuncDefine(A, C, 17, 32);
  end = rdcycle();
  printf("It takes %d cycles for CPU to finish the task.\n", end - start);

  void* cgra_din_addr[6] = {A, A, C, C, C, array3};
  void* cgra_dout_addr[1] = {array3};
  start = rdcycle();
  cgra_execute(cgra_din_addr, cgra_dout_addr);
  volatile int result = fence(1);
  end = rdcycle();
  printf("It takes %d cycles for CGRA to finish the task(%d).\n", end - start, 1);
  printf("CGRA comput finished!\n");
// volatile int result = fence(1);

  // for (i=0;i<16; i++) {
	// printf("%d", C[i]);
	// // printf("%d", sizeof(C[i]));
	// // printf("%s", ",,");
	// printf("%d\n", i);
  // }
    
  result_check();
  printf("Done!\n");

return 0;

}
