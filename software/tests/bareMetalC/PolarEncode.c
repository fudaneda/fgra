#include <string.h>
#include <stdio.h>
#include "include/encoding.h"
#include "include/ISA.h"

int in[1024] __attribute__((aligned(16))) = {0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1,
               1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1,
               0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1,
               1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
               0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1,
			   0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1,
               1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1,
               0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1,
               1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
               0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1};
int in_c[1024] __attribute__((aligned(16))) = {0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1,
               1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1,
               0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1,
               1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
               0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1,
			   0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1,
               1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1,
               0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1,
               1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1,
               1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1,
               0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
               0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1};


#define N 256
#define n 8
int kernel() {
    for (int s = 0; s < n; s++){
        int GP_num = 1 << s;
        int GP_size = N >> s;
        int GP_half_size = GP_size >> 1;
        int curr_GP_base_addr = 0;
        for (int GP_idx = 0; GP_idx < GP_num; GP_idx++){
            for (int t = 0; t < GP_half_size; t++){
                // std::cout << "curr_GP_base_addr: " << curr_GP_base_addr <<" GP_size:"<<GP_size<< std::endl;
                // std::cout << "left: " << curr_GP_base_addr + t << " right: " << (curr_GP_base_addr + t + GP_half_size)<<" puts: " << (in[curr_GP_base_addr + t] ^ in[curr_GP_base_addr + t + GP_half_size])<< std::endl;
                in_c[curr_GP_base_addr + t] ^= in_c[curr_GP_base_addr + t + GP_half_size];
            }
            curr_GP_base_addr += GP_size;
        }
    }
    return 0;
}
__attribute__((noinline))
void cgra_execute(void** din_addr, void** dout_addr)
{
	static unsigned short cin[99][3] __attribute__((aligned(16))) = {
		{0x0000, 0x0000, 0x0010},
		{0x0040, 0x0000, 0x0011},
		{0x0000, 0x2800, 0x0012},
		{0x3203, 0x0800, 0x0013},
		{0x0008, 0x0000, 0x0014},
		{0x0000, 0x0000, 0x0018},
		{0x0040, 0x0000, 0x0019},
		{0x0000, 0xa800, 0x001a},
		{0x3004, 0x2010, 0x001b},
		{0x0003, 0x0000, 0x001c},
		{0x0000, 0x0000, 0x0020},
		{0x0040, 0x0000, 0x0021},
		{0x0000, 0xa800, 0x0022},
		{0x3202, 0x0800, 0x0023},
		{0x0000, 0x0000, 0x0024},
		{0x0030, 0x0000, 0x0048},
		{0x0000, 0x0000, 0x0050},
		{0x0914, 0x0000, 0x0058},
		{0x0828, 0x0000, 0x0088},
		{0x0800, 0x0000, 0x0090},
		{0x0004, 0x0000, 0x00c0},
		{0x8003, 0x0000, 0x00c2},
		{0x4087, 0x0002, 0x00ca},
		{0x0000, 0x0000, 0x00f0},
		{0x1030, 0x0000, 0x00f8},
		{0x0000, 0x0090, 0x0131},
		{0x2000, 0x0180, 0x0139},
		{0x0000, 0x000c, 0x0141},
		{0x0004, 0x0000, 0x0160},
		{0x6003, 0x0000, 0x0162},
		{0x8001, 0x0085, 0x016a},
		{0x0c00, 0x0041, 0x016b},
		{0x0394, 0x0000, 0x016c},
		{0x0010, 0x0008, 0x01a0},
		{0x000c, 0x0000, 0x01a8},
		{0x0000, 0x0020, 0x01d8},
		{0x0080, 0x0000, 0x01e0},
		{0x0000, 0x0020, 0x01e9},
		{0x8081, 0x0005, 0x020a},
		{0x0001, 0x0000, 0x0210},
		{0x8001, 0x0000, 0x0212},
		{0x0008, 0x0000, 0x0218},
		{0x800b, 0x0000, 0x021a},
		{0x0030, 0x0000, 0x0240},
		{0x1034, 0x0000, 0x0248},
		{0x0000, 0x0020, 0x0250},
		{0x0100, 0x0000, 0x0270},
		{0x0000, 0x0100, 0x0278},
		{0x00c0, 0x0300, 0x0281},
		{0x8000, 0x0061, 0x0289},
		{0x0001, 0x0000, 0x02a8},
		{0xa001, 0x0000, 0x02aa},
		{0x6031, 0x0800, 0x02b2},
		{0x0001, 0x3400, 0x02b3},
		{0x0000, 0x0000, 0x02b4},
		{0x2800, 0x0200, 0x02b5},
		{0xc000, 0x1000, 0x02b6},
		{0x0100, 0x0000, 0x02b8},
		{0x000a, 0x0004, 0x02ba},
		{0x0001, 0x0000, 0x02c0},
		{0x0008, 0x0004, 0x02c2},
		{0x0001, 0x0008, 0x02e8},
		{0x0040, 0x0048, 0x02f0},
		{0x0080, 0x0200, 0x02f8},
		{0x0010, 0x0000, 0x0318},
		{0x0000, 0x6300, 0x0329},
		{0x0000, 0x0260, 0x0331},
		{0x0001, 0x0000, 0x0350},
		{0x0031, 0x0008, 0x0352},
		{0x0000, 0x6200, 0x0353},
		{0x0014, 0x0000, 0x0354},
		{0x2800, 0x0000, 0x0355},
		{0xc000, 0x3000, 0x0356},
		{0x0001, 0x0000, 0x0358},
		{0x0021, 0x0008, 0x035a},
		{0x0000, 0x0c00, 0x035b},
		{0x00b4, 0x0000, 0x035c},
		{0x2800, 0x0000, 0x035d},
		{0xc000, 0x1000, 0x035e},
		{0x0001, 0x0000, 0x0360},
		{0xa001, 0x0000, 0x0362},
		{0x0001, 0x0000, 0x0368},
		{0x4009, 0x0000, 0x036a},
		{0x0300, 0x0000, 0x0390},
		{0xc000, 0x0000, 0x0398},
		{0x0c01, 0x0000, 0x03a0},
		{0x0000, 0x0000, 0x03c8},
		{0x0000, 0x0400, 0x03c9},
		{0x0140, 0x0100, 0x03d0},
		{0x0000, 0x0100, 0x03d1},
		{0x0000, 0x0004, 0x03d9},
		{0x400f, 0x0003, 0x0402},
		{0x0001, 0x0000, 0x0408},
		{0x0031, 0x0000, 0x040a},
		{0x0000, 0x2400, 0x040b},
		{0x0000, 0x0000, 0x040c},
		{0x2800, 0x0000, 0x040d},
		{0xc000, 0x1000, 0x040e},
		{0x408f, 0x0002, 0x0412},
	};

	load_cfg((void*)cin, 0x18000, 594, 0, 0);
	load_data(din_addr[0], 0x0, 128, 0, 0, 0);
	config(0x0, 99, 0, 0);
	execute(0xe, 0, 0);
	store(dout_addr[0], 0x0, 128, 0, 0);
}

void result_check()
{
  int i;

  for (i = 0; i < 32; i++)
  {
    if (in_c[i] != in[i]) printf("There is an error in location (%d)[%d, %d]\n", i, in_c[i], in[i]);
  }
}

int main(){

  int i,j;
  long long unsigned start;
  long long unsigned end;

// for (i=0;i<SIZE; i++) printf("%d\n", C[i]);
for (i = 0; i < 1024; i++)
  {
    in_c[i] = i;
	in[i] = i;
  }
  printf("Initialization finished!\n");
  
  // printf("CPU add finished!\n");
  start = rdcycle();
  /* Run kernel. */
  int re = kernel();
  end = rdcycle();
  printf("It takes %d cycles for CPU to finish the task.\n", end - start);

//   void* cgra_din_addr[1] = {in};
//   void* cgra_dout_addr[1] = {in};
//   start = rdcycle();
//   cgra_execute(cgra_din_addr, cgra_dout_addr);
//   volatile int result = fence(1);
//   end = rdcycle();
//   printf("It takes %d cycles for CGRA to finish the task(%d).\n", end - start, 1);
//   printf("CGRA comput finished!\n");
// volatile int result = fence(1);

//   for (i=0;i<64; i++) {
// 	printf("%d", in[i]);
// 	// printf("%d", sizeof(C[i]));
// 	// printf("%s", ",,");
// 	// printf("%d\n", i);
//   }
    
//   result_check();
  printf("\nDone!\n");

return 0;

}
